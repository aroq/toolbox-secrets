tasks:
  gpg:
    bindParamsFromEnv: true
    tasks:
      import_key:
        parameters:
        - name: gpg_key_file
          type: string
        steps:
        - task: core.exec
          arguments:
            title: "GPG :: Import key"
            cmd: |
              gpg --batch --import {{ .gpg_key_file }}

      symmetric:
        parameters:
        - name: TOOLBOX_GPG_SECRET_PASSPHRASE
          type: string
        tasks:
          encrypt:
            parameters:
            - name: input
              type: string
            - name: output
              type: string
            steps:
            - task: core.exec
              arguments:
                title: "GPG :: Symmetric :: Encrypt file"
                cmd: |
                  gpg --symmetric --cipher-algo AES256 {{ .input }}

          decrypt:
            tasks:
              file:
                parameters:
                - name: input
                  type: string
                - name: output
                  type: string
                steps:
                - task: core.exec
                  arguments:
                    title: "GPG :: Symmetric :: Decrypt file"
                    cmd: |
                      echo "${TOOLBOX_GPG_SECRET_PASSPHRASE}" | tr -d '\n' | \
                      gpg --passphrase-fd 0 --quiet --batch --yes --decrypt \
                        --output {{ .output }} {{ .input }};
              dir:
                parameters:
                - name: TOOLBOX_SECRETS_DIR
                  default: .secrets
                steps:
                - task: core.exec
                  arguments:
                    title: "GPG :: Symmetric :: Decrypt all gpg files in the directory :: {{ .TOOLBOX_SECRETS_DIR }}"
                    cmd: |
                      cd {{ .TOOLBOX_SECRETS_DIR }}
                      echo "${TOOLBOX_GPG_SECRET_PASSPHRASE}" | tr -d '\n' | \
                      gpg --passphrase-fd 0 --quiet --batch --yes --decrypt-files *.gpg
